#!/usr/bin/env zunit
###############################
# FICHIER /tests/unit/brew.zunit
###############################

@setup {

    # Setup env
    load "${DIR_SRC}/helpers/parser.zsh"
    brew uninstall --force fortune
    brew uninstall --cask --force caffeine
    # brew install curl
    # brew install visual-studio-code

    # Load script to test
    load "${DIR_SRC}/helpers/brew.zsh"

    # Fixture
    FIXTURE_NO_UPDATE_DUE="${DIR_FIXTURE}/brew/no_update_due.Brewfile"
    FIXTURE_UPDATE_DUE="${DIR_FIXTURE}/brew/update_due.Brewfile"
}

# ────────────────────────────────────────────────────────────────
# TESTS
# ────────────────────────────────────────────────────────────────

@test 'BREW         → Detect if formula is active           → false' {
    run brew_is_f_active "wrong formula"
    assert $state equals 1
}

@test 'BREW         → Detect if formula is active           → true' {
    run brew_is_f_active "curl"
    assert $state equals 0
}

@test 'BREW         → Detect if cask is active              → false' {
    run brew_is_c_active "wrong cask"
    assert $state equals 1
}

@test 'BREW         → Detect if cask is active              → true' {
    run brew_is_c_active "visual-studio-code"
    assert $state equals 0
}

@test 'BREW         → Detect if update is due               → false' {
    run _brew_is_update_due "${FIXTURE_NO_UPDATE_DUE}"
    assert $state equals 0
    assert $output same_as 'false'
}

@test 'BREW         → Detect if update is due               → true' {
    run _brew_is_update_due "${FIXTURE_UPDATE_DUE}"
    assert $state equals 0
    assert $output same_as 'true'
}

@test 'BREW         → Run brew update, bundle, upgrade, cleanup' {
    run brew_bundle "${FIXTURE_UPDATE_DUE}"
    assert $state equals 0
    brew_is_f_active "fortune"
    assert $? equals 0
    run brew_is_c_active "caffeine"
    assert $? equals 0
}

# Test later (don't uninstall it on my local machine !)
# _brew_install

# ────────────────────────────────────────────────────────────────
# CLEANUP
# ────────────────────────────────────────────────────────────────

@teardown {
    brew uninstall --force fortune
    brew uninstall --cask --force caffeine
    # brew uninstall --force curl
    # brew uninstall --cask --force visual-studio-code
}

