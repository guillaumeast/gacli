#!/usr/bin/env zunit
###############################
# FICHIER /tests/unit/brew.zunit
###############################

@setup {

    # Load helpers
    load "${DIR_SRC}/helpers/parser.zsh"

    # Load script to test
    load "${DIR_SRC}/helpers/brew.zsh"

    # Shadow variables
    DIR_FIXTURE="${DIR_FIXTURE}/brew"

    # Fixture
    BREWFILE="${DIR_FIXTURE}/test.Brewfile"
}

# ────────────────────────────────────────────────────────────────
# TESTS
# ────────────────────────────────────────────────────────────────

@test 'BREW         → Detect if formula is active' {
    
    # → false
    brew uninstall --force fortune
    run brew_is_f_active "fortune"
    assert $state equals 1

    # → true
    brew install fortune
    run brew_is_f_active "fortune"
    assert $state equals 0
    brew uninstall --force fortune
}

@test 'BREW         → Detect if cask is active' {
    
    # → false
    brew uninstall --cask --force tablecruncher
    run brew_is_c_active "wrong cask"
    assert $state equals 1

    # → true
    brew install tablecruncher
    run brew_is_c_active "tablecruncher"
    assert $state equals 0
    brew uninstall --cask --force tablecruncher
}

@test 'BREW         → Run brew update, bundle, upgrade, cleanup' {

    # Reset brew setup
    brew uninstall --force fortune
    brew uninstall --cask --force tablecruncher

    # Test
    run brew_bundle "${BREWFILE}"
    assert $state equals 0
    brew_is_f_active "fortune"
    assert $? equals 0
    run brew_is_c_active "tablecruncher"
    assert $? equals 0

    # Reset brew setup
    brew uninstall --force fortune
    brew uninstall --cask --force tablecruncher
}

