#!/usr/bin/env zunit
###############################
# FICHIER /tests/unit/helpers/brew.zunit
###############################

@setup {

    # Setup env
    dir_current="$(dirname "${(%):-%N}")"
    load "${dir_current}/../../../setup.zsh"
    load "${DIR_SRC}/helpers/parser.zsh"
    load "${DIR_SRC}/helpers/brew.zsh"

    # Fixture
    FIXTURE_NO_UPDATE_DUE="/Users/gui/Repos/gacli/gacli/tests/unit/helpers/brew/no_update_due.Brewfile"
    FIXTURE_UPDATE_DUE="/Users/gui/Repos/gacli/gacli/tests/unit/helpers/brew/update_due.Brewfile"
    brew uninstall --force fortune
    brew uninstall --cask --force caffeine
    # brew install curl
    # brew install visual-studio-code
}

# ────────────────────────────────────────────────────────────────
# TESTS
# ────────────────────────────────────────────────────────────────

@test 'Detect inactive formula' {
    run brew_is_f_active "wrong formula"
    assert $state equals 1
}

@test 'Detect active formula' {
    run brew_is_f_active "curl"
    assert $state equals 0
}

@test 'Detect inactive cask' {
    run brew_is_c_active "wrong cask"
    assert $state equals 1
}

@test 'Detect active cask' {
    run brew_is_c_active "visual-studio-code"
    assert $state equals 0
}

@test 'Detect update is due → false' {
    run _brew_is_update_due "${FIXTURE_NO_UPDATE_DUE}"
    assert $state equals 0
    assert $output same_as 'false'
}

@test 'Detect update is due → true' {
    run _brew_is_update_due "${FIXTURE_UPDATE_DUE}"
    assert $state equals 0
    assert $output same_as 'true'
}

@test 'Run brew update, bundle, upgrade, cleanup' {
    run brew_bundle "${FIXTURE_UPDATE_DUE}"
    assert $state equals 0
    brew_is_f_active "fortune"
    assert $? equals 0
    run brew_is_c_active "caffeine"
    assert $? equals 0
}

# Test later (don't uninstall it on my local machine !)
# _brew_install

# ────────────────────────────────────────────────────────────────
# CLEANUP
# ────────────────────────────────────────────────────────────────

@teardown {
    brew uninstall --force fortune
    brew uninstall --cask --force caffeine
}

