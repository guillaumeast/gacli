#!/usr/bin/env zunit
###############################
# FICHIER /tests/unit/helpers/parser/parser.zunit
###############################

@setup {

    # Setup env
    dir_current="$(dirname "${(%):-%N}")"
    load "${dir_current}/../../../setup.zsh"
    load "${DIR_SRC}/helpers/parser.zsh"

    # TODO: fix dynamic paths

    # Fixtures
    FIXTURE_JSON="/Users/gui/Repos/gacli/gacli/tests/unit/helpers/parser/fixture.json"
    FIXTURE_BREW="/Users/gui/Repos/gacli/gacli/tests/unit/helpers/parser/Brewfile"
    EMPTY_BREW="/Users/gui/Repos/gacli/gacli/tests/unit/helpers/parser/empty.Brewfile"

    # Output files
    F_JSON_OUT="/Users/gui/Repos/gacli/gacli/tests/unit/helpers/parser/output/output.json"
    F_BREW_OUT="/Users/gui/Repos/gacli/gacli/tests/unit/helpers/parser/output/Brewfile"

    # Reset output files
    mkdir -p "/Users/gui/Repos/gacli/gacli/tests/unit/helpers/parser/output"
    cp "${FIXTURE_JSON}" "${F_JSON_OUT}"
    cp "${FIXTURE_BREW}" "${F_BREW_OUT}"
}

# ────────────────────────────────────────────────────────────────
# JSON PARSER
# ────────────────────────────────────────────────────────────────

@test 'JSON - read scalar       0 value' {
    run file_read "${FIXTURE_JSON}" scalar_empty
    assert $state equals 0
    assert "$output" is_empty
}

@test 'JSON - read scalar       1 value' {
    run file_read "${FIXTURE_JSON}" scalar_value
    assert $state equals 0
    assert "$output" same_as 'old value 1'
}

@test 'JSON - read list         0 value' {
    run file_read "${FIXTURE_JSON}" list_0
    assert $state equals 0
    assert "$output" is_empty
}

@test 'JSON - read list         2 values' {
    run file_read "${FIXTURE_JSON}" list_2
    assert $state equals 0
    assert "$output" same_as '"old value 1" "old value 2"'
}

# Now we assume that file_read is working as expected
# So we'll check further writing functions by reading the output file with file_read

# Scalar

@test 'JSON - write scalar      0 value     → 1 value' {
    file_write "${F_JSON_OUT}" "scalar_empty" "value 1"
    run file_read "${F_JSON_OUT}" "scalar_empty"
    assert $state equals 0
    assert "$output" same_as 'value 1'
}

@test 'JSON - write scalar      1 value     → 1 value' {
    file_write "${F_JSON_OUT}" "scalar_value" "value 1"
    run file_read "${F_JSON_OUT}" "scalar_value"
    assert $state equals 0
    assert "$output" same_as 'value 1'
}

@test 'JSON - write scalar      1 value     → 0 value' {
    file_write "${F_JSON_OUT}" "scalar_value" ""
    run file_read "${F_JSON_OUT}" "scalar_value"
    assert $state equals 0
    assert "$output" is_empty
}

# Lists

@test 'JSON - reset list        2 values    → 0 value' {
    file_reset "${F_JSON_OUT}" "list_2"
    run file_read "${F_JSON_OUT}" "list_2"
    assert $state equals 0
    assert "$output" is_empty
}

@test 'JSON - add one item      0 value     → 1 value' {
    file_add "${F_JSON_OUT}" "list_0" "new value"
    run file_read "${F_JSON_OUT}" "list_0"
    assert $state equals 0
    assert "$output" same_as '"new value"'
}

@test 'JSON - add two items     2 values    → 4 values' {
    file_add "${F_JSON_OUT}" "list_2" "new value 1" "new value 2"
    run file_read "${F_JSON_OUT}" "list_2"
    assert $state equals 0
    assert "$output" same_as '"old value 1" "old value 2" "new value 1" "new value 2"'
}

@test 'JSON - remove one item   1 value     → 0 value' {
    file_rm "${F_JSON_OUT}" "list_1" "old value 1"
    run file_read "${F_JSON_OUT}" "list_1"
    assert $state equals 0
    assert "$output" is_empty
}

@test 'JSON - remove two items  3 value     → 1 value' {
    file_rm "${F_JSON_OUT}" "list_3" "old value 1" "old value 3"
    run file_read "${F_JSON_OUT}" "list_3"
    assert $state equals 0
    assert "$output" same_as '"old value 2"'
}

# ────────────────────────────────────────────────────────────────
# BREWFILE PARSER
# ────────────────────────────────────────────────────────────────

@test 'BREW - read formula      0 value' {
    run file_read "${EMPTY_BREW}" formulae
    assert $state equals 0
    assert "$output" is_empty
}

@test 'BREW - read casks        0 value' {
    run file_read "${EMPTY_BREW}" casks
    assert $state equals 0
    assert "$output" is_empty
}

@test 'BREW - read formulae     2 values' {
    run file_read "${FIXTURE_BREW}" formulae
    assert $state equals 0
    assert "$output" same_as '"old formula 1" "old formula 2"'
}

@test 'BREW - read casks        2 values' {
    run file_read "${FIXTURE_BREW}" casks
    assert $state equals 0
    assert "$output" same_as '"old cask 1" "old cask 2"'
}

# Now we assume that file_read is working as expected
# So we'll check further writing functions by reading the output file with file_read

# Scalar

@test 'BREW - write formula     2 values    → 3 values' {
    file_write "${F_BREW_OUT}" formulae "new formula 1"
    run file_read "${F_BREW_OUT}" formulae
    assert $state equals 0
    assert "$output" same_as '"old formula 1" "old formula 2" "new formula 1"'
}

@test 'BREW - write cask        2 values    → 3 values' {
    file_write "${F_BREW_OUT}" casks "new cask 1"
    run file_read "${F_BREW_OUT}" casks
    assert $state equals 0
    assert "$output" same_as '"old cask 1" "old cask 2" "new cask 1"'
}

# Reset

@test 'BREW - reset formulae    2 values    → 0 value' {
    file_reset "${F_BREW_OUT}" formulae
    run file_read "${F_BREW_OUT}" formulae
    assert $state equals 0
    assert "$output" is_empty
}

@test 'BREW - reset casks       2 values    → 0 value' {
    file_reset "${F_BREW_OUT}" casks
    run file_read "${F_BREW_OUT}" casks
    assert $state equals 0
    assert "$output" is_empty
}

# Add

@test 'BREW - add formulae      2 values    → 4 values' {
    file_add "${F_BREW_OUT}" formulae "new formula 1" "new formula 2"
    run file_read "${F_BREW_OUT}" formulae
    assert $state equals 0
    assert "$output" same_as '"old formula 1" "old formula 2" "new formula 1" "new formula 2"'
}

@test 'BREW - write casks       2 values    → 4 values' {
    file_add "${F_BREW_OUT}" casks "new cask 1" "new cask 2"
    run file_read "${F_BREW_OUT}" casks
    assert $state equals 0
    assert "$output" same_as '"old cask 1" "old cask 2" "new cask 1" "new cask 2"'
}

# Remove

@test 'BREW - remove formulae   2 values    → 0 value' {
    file_rm "${F_BREW_OUT}" formulae "old formula 1" "old formula 2"
    run file_read "${F_BREW_OUT}" formulae
    assert $state equals 0
    assert "$output" is_empty
}

@test 'BREW - remove casks      2 values    → 0 value' {
    file_rm "${F_BREW_OUT}" casks "old cask 1" "old cask 2"
    run file_read "${F_BREW_OUT}" casks
    assert $state equals 0
    assert "$output" is_empty
}

